name: Normalize and Merge Name Databases

on:
  push:
    paths:
      - 'first-names/*.json' # Added for explicit file matching
      - 'last-names/*.json'
  workflow_dispatch:

# Added: Explicit permissions to allow pushing changes
permissions:
  contents: write

jobs:
  merge-json:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for all branches and tags

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Normalization Script
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          const outputDir = path.join(process.cwd(), 'public');
          if (!fs.existsSync(outputDir)) fs.mkdirSync(outputDir, { recursive: true });

          const processType = (folderName) => {
            // Ensure this matches your actual folder name: 'first-names'
            const sourcePath = path.join(process.cwd(), folderName);
          
            if (!fs.existsSync(sourcePath)) {
              console.error('Directory not found: ' + sourcePath);
              return;
            }

            const files = fs.readdirSync(sourcePath).filter(f => f.endsWith('.json'));
            const list = [];
            let nextId = 1;

            files.forEach(file => {
              try {
                const data = JSON.parse(fs.readFileSync(path.join(sourcePath, file), 'utf8'));
                const teamId = data.teamId;
                const names = data.names || [];

                names.forEach(name => {
                  list.push({
                    id: nextId++,
                    teamId: teamId,
                    name: name
                  });
                });
              } catch (e) {
                console.error('Error parsing ' + file + ':', e.message);
              }
            });
          
            fs.writeFileSync(path.join(outputDir, folderName + '.json'), JSON.stringify(list, null, 2));
            console.log('Processed ' + folderName + ': ' + list.length + ' entries');
          };

          processType('first-names');
          processType('last-names');
          "

      - name: Commit and Push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/*.json
          # Check if there are changes before committing to avoid 'nothing to commit' errors
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: flatten and merge name databases [skip ci]"
            # Pull with rebase to handle remote changes gracefully
            git pull --rebase origin main
            git push origin main
          fi
